from fastapi import FastAPI, Depends, HTTPException, Form, File, UploadFile
from fastapi.security import OAuth2PasswordRequestForm
from sqlalchemy.orm import Session
import uuid

from app.database import Base, engine, get_db
from app import models, schemas, notes
from app.models import User, Note
from app.s3 import upload_file_to_s3 , delete_file_from_s3
from app.auth import hash_password, verify_password, create_access_token, get_current_user

app = FastAPI(title="CloudNotes API")

Base.metadata.create_all(bind=engine)


ALLOWED_TYPES = ["image/jpeg", "image/png", "application/pdf"]

if file and file.content_type not in ALLOWED_TYPES:
    raise HTTPException(status_code=400, detail="File type not allowed")



MAX_FILE_SIZE = 5 * 1024 * 1024  # 5MB

contents = await file.read()
if len(contents) > MAX_FILE_SIZE:
    raise HTTPException(status_code=400, detail="File too large (max 5MB)")

file.file.seek(0)


@app.get("/")
def home():
    return {"message": "CloudNotes API is running!"}


@app.post("/register")
def register(user: schemas.UserCreate, db: Session = Depends(get_db)):
    existing_user = db.query(models.User).filter(models.User.email == user.email).first()
    if existing_user:
        raise HTTPException(status_code=400, detail="Email already registered")

    new_user = models.User(email=user.email, password=hash_password(user.password))
    db.add(new_user)
    db.commit()
    db.refresh(new_user)

    return {"message": "User registered successfully!"}


@app.post("/login")
def login(user: OAuth2PasswordRequestForm = Depends(), db: Session = Depends(get_db)):
    existing_user = db.query(models.User).filter(models.User.email == user.username).first()

    if not existing_user or not verify_password(user.password, existing_user.password):
        raise HTTPException(status_code=401, detail="Invalid email or password")

    access_token = create_access_token(data={"sub": existing_user.email})

    return {"access_token": access_token, "token_type": "bearer"}


@app.post("/notes")
async def create_note(
    title: str = Form(...),
    description: str = Form(...),
    file: UploadFile = File(None),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):


     if file:

          ALLOWED_TYPES = ["image/jpeg", "image/png", "application/pdf"]

          if file and file.content_type not in ALLOWED_TYPES:
              raise HTTPException(status_code=400, detail="File type not allowed")



MAX_FILE_SIZE = 5 * 1024 * 1024  # 5MB

contents = await file.read()
if len(contents) > MAX_FILE_SIZE:
    raise HTTPException(status_code=400, detail="File too large (max 5MB)")

file.file.seek(0)

    file_url = None

    if file:
        unique_filename = f"notes/{current_user.id}/{uuid.uuid4()}_{file.filename}"
        file_url = upload_file_to_s3(file.file, unique_filename, file.content_type)

    new_note = Note(
        title=title,
        description=description,
        user_id=current_user.id,
        file_url=file_url
    )

    db.add(new_note)
    db.commit()
    db.refresh(new_note)

    return new_note


@app.get("/notes", response_model=list[schemas.NoteResponse])
def read_notes(
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user)
):
    return notes.get_user_notes(db, user)



@app.delete("/notes/{note_id}")
def delete_note(note_id: int, db: Session = Depends(get_db), user=Depends(get_current_user)):

    note = db.query(models.Note).filter(models.Note.id == note_id, models.Note.user_id == user.id).first()

    if not note:
        raise HTTPException(status_code=404, detail="Note not found")

    if note.file_url:
        delete_file_from_s3(note.file_url)

    db.delete(note)
    db.commit()

    return {"message": "Note deleted successfully"}
