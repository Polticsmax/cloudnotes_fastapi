from fastapi import FastAPI, Depends, HTTPException, Form, File, UploadFile, Response
from fastapi.security import OAuth2PasswordRequestForm
from sqlalchemy.orm import Session
import uuid

from app.database import Base, engine, get_db
from app import models, schemas, notes
from app.auth import hash_password, verify_password, create_access_token, get_current_user
from app.s3 import upload_file_to_s3 , delete_file_from_s3

app = FastAPI(title="CloudNotes API")

# create tables
Base.metadata.create_all(bind=engine)


@app.get("/")
def home():
    return {"message": "CloudNotes API is running!"}


# ---------------- AUTH ----------------
@app.post("/register")
def register(user: schemas.UserCreate, db: Session = Depends(get_db)):
    existing_user = db.query(models.User).filter(models.User.email == user.email).first()
    if existing_user:
        raise HTTPException(status_code=400, detail="Email already registered")

    new_user = models.User(email=user.email, password=hash_password(user.password))
    db.add(new_user)
    db.commit()
    db.refresh(new_user)

    return {"message": "User registered successfully!"}



@app.post("/login")
def login(user: OAuth2PasswordRequestForm = Depends(), db: Session = Depends(get_db)):
    existing_user = db.query(models.User).filter(models.User.email == user.username).first()

    if not existing_user or not verify_password(user.password, existing_user.password):
        raise HTTPException(status_code=401, detail="Invalid email or password")

    access_token = create_access_token(data={"sub": existing_user.email})
    return {"access_token": access_token, "token_type": "bearer"}


# ---------------- Create notes ----------------
@app.post("/notes", response_model=schemas.NoteResponse)
async def create_note(
    title: str = Form(...),
    description: str = Form(...),
    file: UploadFile = File(None),
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user),
    response: Response = None
):
    file_url = None

    if file:
        unique_filename = f"{uuid.uuid4()}_{file.filename}"
        file_url = upload_file_to_s3(file.file, unique_filename, file.content_type)
        response.headers["X-File-URL"] = file_url

    new_note = models.Note(
        title=title,
        description=description,
        user_id=current_user.id,
        file_url=file_url
    )

    db.add(new_note)
    db.commit()
    db.refresh(new_note)
    return new_note


# ---------------- Read notes ----------------
@app.get("/notes", response_model=list[schemas.NoteResponse])
def read_notes(
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user),
    response: Response = None
):
    user_notes = notes.get_user_notes(db, current_user)

    urls = [note.file_url for note in user_notes if note.file_url]
    if urls:
        response.headers["X-File-URLs"] = ",".join(urls)

    return user_notes


# ---------------- UPDATE NOTE ----------------
@app.put("/notes/{note_id}", response_model=schemas.NoteResponse)
async def update_note(
    note_id: int,
    title: str = Form(...),
    description: str = Form(...),
    file: UploadFile = File(None),
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user),
    response: Response = None
):
    note = db.query(models.Note).filter(
        models.Note.id == note_id,
        models.Note.user_id == current_user.id
    ).first()

    if not note:
        raise HTTPException(status_code=404, detail="Note not found")

    note.title = title
    note.description = description

    if file:
        unique_filename = f"{uuid.uuid4()}_{file.filename}"
        file_url = upload_file_to_s3(file.file, unique_filename, file.content_type)
        note.file_url = file_url
        response.headers["X-File-URL"] = file_url

    db.commit()
    db.refresh(note)
    return note


# ---------------- DELETE NOTE ----------------
@app.delete("/notes/{note_id}")
def delete_note(
    note_id: int,
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    note = db.query(models.Note).filter(
        models.Note.id == note_id,
        models.Note.user_id == current_user.id
    ).first()

    if not note:
        raise HTTPException(status_code=404, detail="Note not found")

    db.delete(note)
    db.commit()
    return {"message": "Note deleted successfully"}

